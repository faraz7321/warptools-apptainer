---
- name: Install Apptainer build dependencies (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
    name:
      - build-essential
      - libseccomp-dev
      - uidmap
      - fakeroot
      - cryptsetup
      - tzdata
      - dh-apparmor
      - curl
      - wget
      - git
      - ca-certificates
      - pkg-config

- name: Install libsubid-dev when available (Ubuntu 24.04+/Debian 12+)
  ansible.builtin.apt:
    name: libsubid-dev
  when: >
    (ansible_facts["distribution"] == "Ubuntu" and ansible_facts["distribution_version"] is version("24.04", ">="))
    or (ansible_facts["distribution"] == "Debian" and ansible_facts["distribution_version"] is version("12", ">="))

- name: Download Go toolchain tarball
  ansible.builtin.get_url:
    url: "https://dl.google.com/go/go{{ go_version }}.linux-amd64.tar.gz"
    dest: "/tmp/go{{ go_version }}.linux-amd64.tar.gz"
    mode: "0644"

- name: Remove existing Go installation (if present)
  ansible.builtin.file:
    path: "/usr/local/go"
    state: absent

- name: Install Go toolchain to /usr/local
  ansible.builtin.unarchive:
    src: "/tmp/go{{ go_version }}.linux-amd64.tar.gz"
    dest: "/usr/local"
    remote_src: true

- name: Ensure Apptainer source directory exists
  ansible.builtin.file:
    path: "{{ apptainer_src_parent }}"
    state: directory
    mode: "0755"

- name: Download Apptainer source tarball
  ansible.builtin.get_url:
    url: "https://github.com/apptainer/apptainer/releases/download/v{{ apptainer_version }}/apptainer-{{ apptainer_version }}.tar.gz"
    dest: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}.tar.gz"
    mode: "0644"

- name: Extract Apptainer sources
  ansible.builtin.unarchive:
    src: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}.tar.gz"
    dest: "{{ apptainer_src_parent }}"
    remote_src: true
    creates: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}"

- name: Configure Apptainer
  ansible.builtin.command:
    cmd: "./mconfig --prefix={{ apptainer_prefix }}"
    chdir: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}"
    creates: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}/builddir/Makefile"
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Build Apptainer
  ansible.builtin.command:
    cmd: "make -C builddir"
    chdir: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}"
  environment:
    # Avoids some environments failing on a missing $HOME during 'go build'.
    HOME: "/root"
    PATH: "/usr/local/go/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Install Apptainer
  ansible.builtin.command:
    cmd: "make -C builddir install"
    chdir: "{{ apptainer_src_parent }}/apptainer-{{ apptainer_version }}"
    creates: "{{ apptainer_prefix }}/bin/apptainer"
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_facts['env']['PATH'] }}"
